<!DOCTYPE html>
<html lang="uk">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Список продуктів</title>

		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<!-- FontAwesome -->
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
			rel="stylesheet"
		/>

		<style>
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				padding: 30px 15px;
				background: #f8f9fa;
				min-height: 100vh;
			}
			a.nav-link {
				font-weight: 600;
			}
			h1 {
				font-weight: 700;
				margin-bottom: 1.5rem;
				color: #343a40;
			}
			.search-section h2 {
				font-weight: 600;
				color: #495057;
				margin-bottom: 0.5rem;
			}
			.api-badge {
				background: linear-gradient(45deg, #28a745, #20c997);
				color: white;
				padding: 0.3rem 0.9rem;
				border-radius: 20px;
				font-weight: 600;
				font-size: 0.85rem;
			}
			.btn-delete {
				transition: background-color 0.3s ease;
			}
			.btn-delete:hover {
				background-color: #dc3545;
				color: white;
			}
			#errorMessage {
				margin: 15px 0;
				font-weight: 600;
				background-color: #fff3f3;
				padding: 10px 15px;
				border-radius: 5px;
				border-left: 4px solid #dc3545;
				display: none;
			}
			/* Подсветка удаляемой строки */
			tr.deleting {
				background-color: #ffe6e6 !important;
				color: #a00 !important;
				transition: background-color 0.5s ease;
			}
			/* Модальное окно подтверждения */
			#confirmModalBackdrop {
				position: fixed;
				top: 0;
				left: 0;
				width: 100vw;
				height: 100vh;
				background-color: rgba(0, 0, 0, 0.5);
				display: none;
				justify-content: center;
				align-items: center;
				z-index: 1050;
			}
			#confirmModal {
				background: white;
				padding: 25px 30px;
				border-radius: 8px;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
				max-width: 400px;
				width: 90%;
				text-align: center;
			}
			#confirmModal p {
				margin-bottom: 25px;
				font-size: 18px;
				font-weight: 600;
				color: #333;
			}
			.cache-info {
				font-size: 0.85rem;
				color: #6c757d;
				margin-top: 5px;
			}
			.table-container {
				position: relative;
			}
			.search-row {
				display: flex;
				flex-wrap: wrap;
				gap: 20px;
				margin-bottom: 20px;
			}
			.search-group {
				flex: 1;
				min-width: 250px;
			}
		</style>
	</head>
	<body>
		<!-- Навигация -->
		<nav class="mb-4">
			<a
				href="https://fetchtest-oc9k.onrender.com/lproductList.html"
				class="nav-link d-inline me-3 text-decoration-none text-primary"
			>
				<i class="fas fa-table me-1"></i> Таблица продуктов
			</a>
			<a
				href="https://fetchtest-oc9k.onrender.com/create.product.html"
				class="nav-link d-inline me-3 text-decoration-none text-primary"
			>
				<i class="fas fa-plus-circle me-1"></i> Создание продуктов
			</a>
			<a
				href="https://fetchtest-oc9k.onrender.com/productById.html"
				class="nav-link d-inline text-decoration-none text-primary"
			>
				<i class="fas fa-search me-1"></i> Продукт по ID
			</a>
		</nav>

		<h1>Список продуктів</h1>

		<!-- Блок поиска по ID и названию на одном уровне -->
		<div class="search-section">
			<div class="search-row">
				<div class="search-group">
					<label for="searchById" class="form-label fw-semibold"
						>Пошук по ID</label
					>
					<input
						id="searchById"
						type="number"
						placeholder="Введіть ID продукту"
						class="form-control"
					/>
				</div>
				<div class="search-group">
					<label for="searchByName" class="form-label fw-semibold"
						>Пошук за назвою</label
					>
					<input
						id="searchByName"
						type="text"
						placeholder="Введіть назву продукту"
						class="form-control"
						autocomplete="off"
					/>
					<div id="cacheInfo" class="cache-info"></div>
				</div>
			</div>
		</div>

		<div id="errorMessage" class="text-danger"></div>

		<div class="table-container">
			<table class="table table-striped table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th>ID</th>
						<th>Назва</th>
						<th>Опис</th>
						<th>Ціна</th>
						<th>Категорія</th>
						<th>Кількість</th>
						<th>Бренд</th>
						<th>Видалити</th>
					</tr>
				</thead>
				<tbody id="productsTableBody">
					<!-- Продукти будуть тут -->
				</tbody>
			</table>
		</div>

		<!-- Модальное окно подтверждения -->
		<div id="confirmModalBackdrop">
			<div id="confirmModal">
				<p>Видалити цей продукт?</p>
				<button id="confirmDeleteBtn" class="btn btn-danger me-2">
					Видалити
				</button>
				<button id="cancelDeleteBtn" class="btn btn-secondary">
					Скасувати
				</button>
			</div>
		</div>

		<!-- Bootstrap Bundle JS (Popper + Bootstrap) -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			let productCache = {}; // Кеш результатов поиска
			let searchTimeout; // Таймер для debounce
			let productIdToDelete = null;
			let rowToDelete = null;
			const CACHE_LIMIT = 20; // Максимальное количество записей в кеше
			const SEARCH_DELAY = 300; // Задержка перед поиском в мс
			const MIN_SEARCH_LENGTH = 2; // Минимальная длина для поиска по названию

			// Функция для поиска продуктов с использованием кеша
			async function searchProducts(idFilter = '', nameFilter = '') {
				// Генерируем ключ для кеша
				const cacheKey = generateCacheKey(idFilter, nameFilter);
				const cacheInfo = document.getElementById("cacheInfo");
				
				// Проверяем кеш
				if (productCache[cacheKey]) {
					cacheInfo.textContent = "Результати з кешу";
					cacheInfo.style.color = "#28a745";
					return productCache[cacheKey];
				}
				
				// Если нет в кеше, делаем запрос к серверу
				try {
					const params = new URLSearchParams();
					if (idFilter) params.append('id', idFilter);
					if (nameFilter) params.append('name', nameFilter);
					
					const response = await fetch(`/api/products/search?${params.toString()}`, {
						method: "GET",
						headers: { "Content-Type": "application/json" },
					});
					
					if (!response.ok) throw new Error(`Помилка сервера: ${response.status}`);
					const products = await response.json();
					
					// Сохраняем в кеш (если есть результаты)
					if (products.length > 0) {
						addToCache(cacheKey, products);
						cacheInfo.textContent = "Нові результати (додано до кешу)";
						cacheInfo.style.color = "#007bff";
					} else {
						cacheInfo.textContent = "Нічого не знайдено";
						cacheInfo.style.color = "#6c757d";
					}
					
					return products;
				} catch (error) {
					cacheInfo.textContent = "Помилка пошуку";
					cacheInfo.style.color = "#dc3545";
					throw error;
				}
			}

			// Генерация ключа для кеша
			function generateCacheKey(idFilter, nameFilter) {
				return `id:${idFilter}_name:${nameFilter.toLowerCase()}`;
			}

			// Добавление в кеш с ограничением размера
			function addToCache(key, data) {
				// Если кеш достиг лимита, удаляем самый старый элемент
				const keys = Object.keys(productCache);
				if (keys.length >= CACHE_LIMIT) {
					delete productCache[keys[0]];
				}
				
				productCache[key] = data;
			}

			// Очистка кеша
			function clearCache() {
				productCache = {};
				document.getElementById("cacheInfo").textContent = "Кеш очищено";
				document.getElementById("cacheInfo").style.color = "#6c757d";
			}

			function renderProducts(products) {
				const tbody = document.getElementById("productsTableBody");
				const errorMessage = document.getElementById("errorMessage");
				
				tbody.innerHTML = "";
				errorMessage.style.display = "none";

				if (products.length === 0) {
					tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Продукти не знайдені</td></tr>`;
					return;
				}

				products.forEach(product => {
					const tr = document.createElement("tr");
					tr.setAttribute("data-product-id", product.id);
					tr.innerHTML = `
          <td><a href="productById.html?id=${
						product.id
					}" title="Перейти до продукту">${product.id || ""}</a></td>
          <td><a href="productById.html?id=${
						product.id
					}" class="text-decoration-none text-primary">${
						product.name || ""
					}</a></td>
          <td>${product.description || ""}</td>
          <td>${product.price != null ? product.price.toFixed(2) : ""}</td>
          <td>${product.category || ""}</td>
          <td>${product.quantity != null ? product.quantity : ""}</td>
          <td>${product.brand || ""}</td>
          <td>
            <button class="btn btn-outline-danger btn-sm btn-delete" onclick="confirmDelete(${
							product.id
						}, this.closest('tr'))">
              <i class="fas fa-trash-alt"></i> Видалити
            </button>
          </td>
        `;
					tbody.appendChild(tr);
				});
			}

			function showError(message) {
				const errorMessage = document.getElementById("errorMessage");
				errorMessage.textContent = message;
				errorMessage.style.display = "block";
			}

			function hideError() {
				document.getElementById("errorMessage").style.display = "none";
			}

			// Применение фильтров с debounce и проверкой минимальной длины
			async function applyFilters() {
				const idFilter = document.getElementById("searchById").value.trim();
				const nameFilter = document.getElementById("searchByName").value.trim();
				
				// Очищаем предыдущий таймаут
				clearTimeout(searchTimeout);
				hideError();
				
				// Не ищем если слишком короткий запрос по названию и нет ID
				if (nameFilter.length > 0 && nameFilter.length < MIN_SEARCH_LENGTH && !idFilter) {
					document.getElementById("cacheInfo").textContent = 
						`Введіть щонайменше ${MIN_SEARCH_LENGTH} символи для пошуку`;
					document.getElementById("cacheInfo").style.color = "#6c757d";
					return;
				}
				
				// Устанавливаем задержку перед поиском
				searchTimeout = setTimeout(async () => {
					try {
						const products = await searchProducts(idFilter, nameFilter);
						renderProducts(products);
					} catch (error) {
						showError("❌ Помилка при пошуку: " + error.message);
					}
				}, SEARCH_DELAY);
			}

			async function deleteProduct(productId) {
				try {
					const response = await fetch(`/api/products/${productId}`, {
						method: "DELETE",
					});
					if (!response.ok) throw new Error("Не вдалося видалити продукт");

					// Очищаем кеш, так как данные изменились
					clearCache();
					
					// Выполняем текущий поиск заново
					await applyFilters();
				} catch (error) {
					showError("❌ Помилка при видаленні: " + error.message);
				}
			}

			// Показать модальное окно подтверждения
			function confirmDelete(productId, row) {
				productIdToDelete = productId;
				rowToDelete = row;
				rowToDelete.classList.add("deleting");
				document.getElementById("confirmModalBackdrop").style.display = "flex";
			}

			// Отмена удаления
			function cancelDelete() {
				if (rowToDelete) {
					rowToDelete.classList.remove("deleting");
					rowToDelete = null;
				}
				productIdToDelete = null;
				document.getElementById("confirmModalBackdrop").style.display = "none";
			}

			// Подтверждение удаления
			async function confirmDeletion() {
				if (productIdToDelete !== null && rowToDelete !== null) {
					// Подтверждено — удаляем продукт
					await deleteProduct(productIdToDelete);

					// Снимаем подсветку и скрываем модалку
					rowToDelete.classList.remove("deleting");
					rowToDelete = null;
					productIdToDelete = null;
					document.getElementById("confirmModalBackdrop").style.display =
						"none";
				}
			}

			document
				.getElementById("cancelDeleteBtn")
				.addEventListener("click", cancelDelete);
			document
				.getElementById("confirmDeleteBtn")
				.addEventListener("click", confirmDeletion);

			document.addEventListener("DOMContentLoaded", () => {
				document
					.getElementById("searchById")
					.addEventListener("input", applyFilters);
				document
					.getElementById("searchByName")
					.addEventListener("input", applyFilters);

				// Первоначальная загрузка популярных товаров
				applyFilters();
			});

			// Добавляем функцию clearCache в глобальную область видимости
			window.clearCache = clearCache;
		</script>
	</body>
</html>